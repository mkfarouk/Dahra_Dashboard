<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aldahra Agricultural Company - Enhanced Dashboard</title>
    
    <!-- External Libraries -->
    

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="assets/css/variables.css" />
    <link rel="stylesheet" href="assets/css/theme-dark.css" />
    <link rel="stylesheet" href="assets/css/base.css" />
    <link rel="stylesheet" href="assets/css/layout.css" />

    <link rel="stylesheet" href="assets/css/components-crop-cards.css" />
    <link rel="stylesheet" href="assets/css/components-varieties.css" />
    <link rel="stylesheet" href="assets/css/components-charts.css" />
    <link rel="stylesheet" href="assets/css/components-sidebar.css" />
    <link rel="stylesheet" href="assets/css/components-loading.css" />

    <link rel="stylesheet" href="assets/css/utilities.css" />
    <link rel="stylesheet" href="assets/css/responsive.css" />

    <script type="module" src="assets/js/mock/mockData.js"></script>



    
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinning">
                <i class="fas fa-leaf"></i>
            </div>
            <p>Loading Enhanced Agricultural Dashboard...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <!-- Aldahra Logo -->
                <img src="https://images.wuzzuf-data.net/files/company_logo/Al-Dahra-Agriculture-Egypt-53315-1594802755-og.png" alt="Aldahra Logo" class="company-logo">
            </div>
            
            <div class="header-controls">
                <div class="control-buttons">
                    <button class="dark-mode-toggle" id="darkModeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <select id="cropSelector" class="modern-select">
                        <option value="all">All Crops</option>
                        <!-- Crop options will be dynamically generated -->
                    </select>
                    
                    <select id="locationSelector" class="modern-select">
                        <option value="all">All Locations</option>
                        <option value="toshka">üìç Toshka</option>
                        <option value="eastowinat">üìç East Oweinat</option>
                    </select>
                    
                    <input type="text" id="datePicker" placeholder="Select date range" class="date-input" />
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="left-content">
            <!-- Crop Selection Section -->
            <section class="crop-selection-section">
                <h2 class="section-title">
                    <i class="fas fa-leaf"></i>
                    Crop Management Overview
                </h2>
                
                <div class="crop-cards-container" id="cropCards">
                    <!-- Crop cards will be dynamically generated -->
                </div>
            </section>

            <!-- Crop Varieties Section -->
            <section class="crop-varieties" id="cropVarieties">
                <h3 class="section-title">
                    <i class="fas fa-seedling"></i>
                    <span id="selectedCropName">Crop</span> Varieties
                </h3>
                <div class="varieties-content">
                    <div class="varieties-list" id="varietiesGrid">
                        <!-- Varieties will be dynamically generated -->
                    </div>
                    <div class="varieties-map">
                        <div id="varietiesMapContainer"></div>
                    </div>
                </div>
            </section>

            <!-- Production Chart -->
            <section class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-chart-area"></i>
                        Production Trends Analysis
                    </h3>
                    <div class="chart-controls">
                        <button class="chart-btn active" data-period="6m">6M</button>
                        <button class="chart-btn" data-period="1y">1Y</button>
                        <button class="chart-btn" data-period="2y">2Y</button>
                    </div>
                </div>
                <div id="productionChart"></div>
            </section>

            <!-- Comparison Chart Section -->
            <section class="comparison-section">
                <div class="comparison-header">
                    <h3 class="chart-title">
                        <i class="fas fa-chart-line"></i>
                        Location Comparison
                    </h3>
                    <div class="location-tabs">
                        <button class="location-tab active" data-location="both">Both</button>
                        <button class="location-tab toshka" data-location="toshka">Toshka</button>
                        <button class="location-tab eastowinat" data-location="eastowinat">East Oweinat</button>
                    </div>
                </div>
                <div id="comparisonChart"></div>
            </section>
        </div>

        <div class="right-sidebar">
            <!-- Weather Widget -->
            <section class="sidebar-section">
                <h3 class="sidebar-title">
                    <i class="fas fa-cloud-sun"></i>
                    Weather Information
                </h3>
                <div class="weather-widget">
                    <div class="weather-current">
                        <div class="weather-temp" id="sidebarTemp"></div>
                        <div class="weather-condition" id="sidebarCondition"></div>
                    </div>
                    <div class="weather-details-grid">
                        <div class="weather-detail-item">
                            <div class="weather-detail-value" id="sidebarWind"></div>
                            <div class="weather-detail-label">Wind Speed</div>
                        </div>
                        <div class="weather-detail-item">
                            <div class="weather-detail-value" id="sidebarHumidity"></div>
                            <div class="weather-detail-label">Humidity</div>
                        </div>
                        <div class="weather-detail-item">
                            <div class="weather-detail-value" id="sidebarPressure"></div>
                            <div class="weather-detail-label">Pressure</div>
                        </div>
                        <div class="weather-detail-item">
                            <div class="weather-detail-value" id="sidebarVisibility"></div>
                            <div class="weather-detail-label">Visibility</div>
                        </div>
                    </div>
                    <div class="weather-forecast" id="weatherForecast">
                        <!-- Forecast will be dynamically generated by getWeather() -->
                    </div>
                </div>
            </section>

            <!-- Weather Analysis Chart Section -->
            <section class="sidebar-section weather-analysis-section" style="display:block;">
                <h3 class="weather-analysis-title">
                    <i class="fas fa-chart-line"></i>
                    Weather Trends
                </h3>
                <div id="weatherAnalysisChart" style="height:210px;"></div>
            </section>

            <!-- Overall Crops Map -->
            <section class="sidebar-section crops-map-section">
                <h3 class="sidebar-title">
                    <i class="fas fa-map-marked-alt"></i>
                    Crops Location Map
                </h3>
                <div class="crops-map-container">
                    <div id="cropsMapContainer"></div>
                </div>
            </section>

            <!-- Enhanced Key Metrics -->
            <section class="sidebar-section key-metrics">
                <h3 class="sidebar-title">
                    <i class="fas fa-tachometer-alt"></i>
                    Key Metrics
                </h3>
                <div class="metrics-grid" id="metricsGrid">
                    <!-- Metrics will be dynamically generated -->
                </div>
            </section>
        </div>
    </main>

        <script>
            // Dynamically populate cropSelector with crop names from data.json
                    async function populateCropSelector() {
                        const selector = document.getElementById('cropSelector');
                        try {
                            const response = await fetch('./assets/js/real_data/data.json');
                            const data = await response.json();
                            // Only crops with harvested_weight
                            const cropNames = [...new Set(data.filter(crop => crop.harvested_weight != null).map(crop => crop.crop_name).filter(Boolean))];
                            cropNames.forEach(name => {
                                const option = document.createElement('option');
                                option.value = name.toLowerCase().replace(/\s+/g, '_');
                                option.textContent = name;
                                selector.appendChild(option);
                            });
                        } catch (error) {
                            console.error('Error loading crop names:', error);
                        }
                    }
            populateCropSelector();

            // Filtering crop cards based on selection
            async function renderCropCards(filter = 'all') {
                const container = document.getElementById('cropCards');
                const response = await fetch('./assets/js/real_data/data.json');
                const data = await response.json();
                container.innerHTML = '';
                                let crops;
                                if (filter === 'all') {
                                    crops = data.filter(crop => crop.crop_name && crop.harvested_weight != null);
                                } else {
                                    crops = data.filter(crop => crop.crop_name && crop.harvested_weight != null && crop.crop_name.toLowerCase().replace(/\s+/g, '_') === filter);
                                }
                const cardsFragment = document.createDocumentFragment();
                crops.forEach((crop, idx) => {
                  const key = crop.crop_id || `crop-${idx}`;
                  const card = document.createElement('div');
                  card.className = `crop-card ${key}`;
                  card.dataset.crop = key;
                  card.style.cursor = 'pointer';
                  card.innerHTML = `
                    <div class="crop-header">
                      <h3 class="crop-name">${crop.crop_name}</h3>
                      <span class="crop-icon">üå±</span>
                    </div>
                    <div class="crop-stats">
                      <div class="stat-item"><div class="stat-value">${crop.harvested_weight ?? '-'}</div><div class="stat-label">Weight</div></div>
                      <div class="stat-item"><div class="stat-value">${crop.harvesting_date ?? '-'}</div><div class="stat-label">Date</div></div>
                    </div>
                  `;
                  card.addEventListener('click', () => {
                    document.querySelectorAll('.crop-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    const detailsSection = document.getElementById('crop-details-section');
                    if (detailsSection) {
                      detailsSection.innerHTML = `
                        <div class="crop-details-box" style="background:#f6fff6;border-radius:32px;padding:32px 40px;box-shadow:0 4px 24px rgba(76,175,80,0.10);margin-top:24px;display:flex;flex-direction:row;gap:48px;align-items:center;min-height:300px;">
                          <div style="flex:1;display:flex;flex-direction:column;justify-content:center;gap:18px;">
                            <h2 style="color:#388E3C;margin-bottom:18px;font-size:1.6rem;font-weight:600;">${crop.crop_name} Details</h2>
                            <div style="font-size:1.1rem;"><strong>Variety:</strong> <span style="color:#388E3C;">${crop.variety ?? '-'}</span></div>
                            <div style="font-size:1.1rem;"><strong>Till Area:</strong> <span style="color:#388E3C;">${crop.till_area ?? '-'}</span></div>
                            <div style="font-size:1.1rem;"><strong>Field Name:</strong> <span style="color:#388E3C;">${crop.field_name ?? '-'}</span></div>
                          </div>
                          <div style="flex:1;display:flex;justify-content:center;align-items:center;">
                            <div id="crop-map" style="height:240px;width:100%;max-width:340px;border-radius:18px;box-shadow:0 2px 8px rgba(76,175,80,0.10);"></div>
                          </div>
                        </div>
                      `;
                      if (crop.lat && crop.long && window.L) {
                        setTimeout(() => {
                          const mapDiv = document.getElementById('crop-map');
                          mapDiv.innerHTML = '';
                          const map = L.map(mapDiv).setView([crop.lat, crop.long], 14);
                          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '¬© OpenStreetMap contributors'
                          }).addTo(map);
                          L.marker([crop.lat, crop.long]).addTo(map)
                            .bindPopup(`${crop.crop_name} Field`).openPopup();
                        }, 100);
                      }
                    }
                  });
                  cardsFragment.appendChild(card);
                });
                container.appendChild(cardsFragment);
                // Details section always below all cards, visually separated and filling blank
                let detailsSection = document.getElementById('crop-details-section');
                if (!detailsSection) {
                  detailsSection = document.createElement('div');
                  detailsSection.id = 'crop-details-section';
                  detailsSection.style.marginTop = '40px';
                  detailsSection.style.width = '100%';
                  detailsSection.style.maxWidth = '1200px';
                  detailsSection.style.marginLeft = 'auto';
                  detailsSection.style.marginRight = 'auto';
                  detailsSection.style.display = 'ma';
                  detailsSection.style.position = 'relative';
                  container.parentElement.appendChild(detailsSection);
                }
              }
              // Initial render
              renderCropCards('all');
              document.getElementById('cropSelector').addEventListener('change', function() {
                renderCropCards(this.value);
              });
            </script>
        <script type="module" src="assets/js/main.js"></script>
        <script>
            async function getWeather(location = 'Egypt') {
  const apiKey = '2063af61c85641aa8fb120249250909';
  const url = (loc) => `https://api.weatherapi.com/v1/forecast.json?key=${apiKey}&q=${loc}&days=3&aqi=no`;
  let locations = [];
  if (location === 'all') {
    locations = ['22.6137,31.2889,Toshka', '22.2257,28.7374,Sharq El Owainat'];
  } else if (location === 'toshka') {
    locations = ['22.6137,31.2889,Toshka'];
  } else if (location === 'eastowinat') {
    locations = ['22.2257,28.7374,Sharq El Owainat'];
  } else {
    locations = [location];
  }
  try {
    const results = await Promise.all(locations.map(loc => fetch(url(loc)).then(r => r.json())));
    // If averaging, do so for all metrics
    let avg = (arr) => arr.reduce((a, b) => a + b, 0) / arr.length;
    let weather = results[0];
    if (locations.length === 2) {
      // Average current metrics
      const temp = avg(results.map(r => r.current.temp_c));
      const wind = avg(results.map(r => r.current.wind_kph));
      const humidity = avg(results.map(r => r.current.humidity));
      const pressure = avg(results.map(r => r.current.pressure_mb));
      const visibility = avg(results.map(r => r.current.vis_km));
      // Average forecast metrics for today, tomorrow, day after
      const forecast = [0,1,2].map(i => {
        return {
          date: results[0].forecast.forecastday[i].date,
          avgtemp_c: avg(results.map(r => r.forecast.forecastday[i].day.avgtemp_c)),
          maxtemp_c: avg(results.map(r => r.forecast.forecastday[i].day.maxtemp_c)),
        };
      });
      // Update UI
      document.getElementById('sidebarTemp').textContent = `${temp.toFixed(1)}¬∞C`;
      document.getElementById('sidebarCondition').textContent = 'Average';
      document.getElementById('sidebarWind').textContent = `${wind.toFixed(1)} km/h`;
      document.getElementById('sidebarHumidity').textContent = `${humidity.toFixed(1)}%`;
      document.getElementById('sidebarPressure').textContent = `${pressure.toFixed(1)} hPa`;
      document.getElementById('sidebarVisibility').textContent = `${visibility.toFixed(1)} km`;
      const forecastDiv = document.getElementById('weatherForecast');
      forecastDiv.innerHTML = '';
      ['Today', 'Tomorrow', 'Day After'].forEach((label, idx) => {
        const day = forecast[idx];
        const forecastItem = document.createElement('div');
        forecastItem.className = 'forecast-item';
        forecastItem.innerHTML = `<span class="forecast-day">${label}</span><span class="forecast-temp">${day.avgtemp_c.toFixed(1)}¬∞C</span>`;
        forecastDiv.appendChild(forecastItem);
      });
      return;
    } else {
      // Single location, use as before
      document.getElementById('sidebarTemp').textContent = `${weather.current.temp_c}¬∞C`;
      document.getElementById('sidebarCondition').textContent = weather.current.condition.text;
      document.getElementById('sidebarWind').textContent = `${weather.current.wind_kph} km/h`;
      document.getElementById('sidebarHumidity').textContent = `${weather.current.humidity}%`;
      document.getElementById('sidebarPressure').textContent = `${weather.current.pressure_mb} hPa`;
      document.getElementById('sidebarVisibility').textContent = `${weather.current.vis_km} km`;
      const forecastDiv = document.getElementById('weatherForecast');
      forecastDiv.innerHTML = '';
      if (weather.forecast && weather.forecast.forecastday) {
        weather.forecast.forecastday.slice(0,3).forEach((day, idx) => {
          const labels = ['Today', 'Tomorrow', 'Day After'];
          const forecastItem = document.createElement('div');
          forecastItem.className = 'forecast-item';
          forecastItem.innerHTML = `<span class="forecast-day">${labels[idx]}</span><span class="forecast-temp">${day.day.avgtemp_c}¬∞C</span>`;
          forecastDiv.appendChild(forecastItem);
        });
      }
    }
  } catch (error) {
    console.error('Weather API error:', error);
  }
}

// Listen for location selector changes
const locationSelector = document.getElementById('locationSelector');
if (locationSelector) {
  locationSelector.addEventListener('change', function() {
    getWeather(this.value);
  });
}
// Initial weather render
getWeather(locationSelector ? locationSelector.value : 'all');
        </script>
</body>
</html>




